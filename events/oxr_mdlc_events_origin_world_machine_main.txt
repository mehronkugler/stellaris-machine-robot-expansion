namespace = oxr_mdlc_origin_wm_main

country_event = {
	id = oxr_mdlc_origin_wm_main.1
	title = oxr_mdlc_origin_wm_starting_overview
	desc = oxr_mdlc_origin_wm_starting_overview_desc
	picture = GFX_evt_ai_planet
	is_triggered_only = yes

	option = {
		name = oxr_mdlc_origin_wm_main.1.a.name
	}
}

# Trigger project to get proficiency tech
# although I am on the fence and maybe just award it
country_event = {
	id = oxr_mdlc_origin_wm_main.50
	title = oxr_mdlc_origin_wm_main.50.title
	desc = oxr_mdlc_origin_wm_main.50.desc
	picture = GFX_evt_engineering_research
	is_triggered_only = yes

	trigger = { }

	option = {
		name = oxr_mdlc_origin_wm_main.50.a
		owner = {
			enable_special_project = {
				name = OXR_MDLC_ORIGIN_WM_TECH_PROFICIENCY
			}
		}
	}
	immediate = {
		owner = {
			end_event_chain = oxr_mdlc_origin_wm_chain_clear_blockers
		}
	}
}

# Finished the 'deploy world cores' event chain
country_event = {
	id = oxr_mdlc_origin_wm_main.60
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_event_chain = "oxr_mdlc_origin_wm_chain_deploy_world_cores"
		NOT = { has_completed_event_chain = oxr_mdlc_origin_wm_chain_deploy_world_cores }
	}
	immediate = {
		# award an insight
		country_event = {
			id = oxr_mdlc_on_world_machine_action.110
		}
		# finish this event chain
		end_event_chain = oxr_mdlc_origin_wm_chain_deploy_world_cores
	}
}

# Planet has been terraformed
# This = Planet
# From = Terraforming country
planet_event = {
	id = oxr_mdlc_origin_wm_main.500
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		from = {
			has_origin = oxr_mdlc_origin_world_machine_awakened
		}
	}

	immediate = {
		create_colony = {
			owner = from
			species = from.owner_species
			# Set name .. read a variable on the planet as a list index
			# then according to that, set the name
		}
		add_deposit = oxr_mdlc_d_world_machine_core
		if = {
			limit = {
				from = {
					NOT = {
						has_technology = oxr_mdlc_tech_world_machine_planetary_mastery
					}
				}
			}
			oxr_mdlc_origin_world_machine_random_add_all_blockers = yes
			oxr_mdlc_origin_world_machine_create_digsite_for_blocker = yes
			# Don't trigger the event post-terraform if planet was ruined
			if = {
				limit = {
					has_planet_flag = oxr_mdlc_ruined_world_machine
				}
				remove_planet_flag = oxr_mdlc_ruined_world_machine
			}
			else = {
				planet_event = {
					id = oxr_mdlc_origin_wm_main.501
				}
			}
		}
		add_modifier = { modifier = "planet_population_control_gestalt" days = -1 }
		from = {
			oxr_mdlc_world_machine_cores_recalc_amount = yes
			fire_on_action = {
				on_action = on_world_machine_core_terraforming_complete
			}
		}
		# Effectively set max storage amount to 0
		oxr_mdlc_planet_calculate_max_core_storage = yes
		set_variable = {
			which = oxr_mdlc_world_machine_expansion_levels
			value = 0
		}
		set_variable = {
			which = oxr_mdlc_planet_world_machine_cores_amount
			value = 0
		}
		set_saved_date = {
			key = oxr_mdlc_world_machine_founded_date
			days_from_present = 0
			expires = -1
		}
		add_modifier = {
			modifier = oxr_mdlc_planet_origin_world_machine_info
			days = -1
		}
	}
}

planet_event = {
	id = oxr_mdlc_origin_wm_main.501
	title = oxr_mdlc_origin_wm_main.501.title
	desc = oxr_mdlc_origin_wm_main.501.desc
	picture = GFX_evt_colony_settlement
	is_triggered_only = yes

	option = {
		name = oxr_mdlc_origin_wm_main.501.a
		space_owner = {
			add_resource = {
				society_research = 750
				engineering_research = 750
				physics_research = 750
			}
		}
	}
	option = {
		name = oxr_mdlc_origin_wm_main.501.b
		space_owner = {
			add_resource = {
				unity = 1000
			}
		}
	}
	option = {
		name = oxr_mdlc_origin_wm_main.501.c
		space_owner = {
			add_resource = {
				energy = -250
			}
		}
		planet_event = {
			id = oxr_mdlc_origin_wm_main.502
			days = 14
		}
	}
}

planet_event = {
	id = oxr_mdlc_origin_wm_main.502
	title = oxr_mdlc_origin_wm_main.502.title
	desc = oxr_mdlc_origin_wm_main.502.desc
	picture = GFX_evt_glitchy_matrix
	is_triggered_only = yes

	option = {
		name = "oxr_mdlc_origin_wm_main.502.a"
		space_owner = {
			random_situation = {
				limit = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
				add_situation_progress = @oxr_mdlc_situation_core_tech_fun_points
			}
		}
	}
}

### RUINED WORLD MACHINE ###
# Decision triggers this event, which triggers others


# Introduction, enter stage 1
country_event = {
	id = oxr_mdlc_origin_wm_main.1000
	title = "oxr_mdlc_origin_wm_main.1000.title"
	desc = "oxr_mdlc_origin_wm_main.1000.desc"
	picture = GFX_evt_engineering_cache
	is_triggered_only = yes
	location = event_target:oxr_mdlc_ruined_world_machine

	trigger = {
		root = {
			any_situation = {
				is_situation_type = oxr_mdlc_origin_wm_situation_restore_ruined_world_machine
			}
		}
	}

	option = {
		name = oxr_mdlc_origin_wm_main.1000.a
		hidden_effect = {
			log = "Do nothing"
		}
	}
	immediate = { log = "Do nothing" }
}

country_event = {
	# enter stage 2, power on self test
	id = oxr_mdlc_origin_wm_main.1005
	title = oxr_mdlc_origin_wm_main.1005.title
	desc = oxr_mdlc_origin_wm_main.1005.desc
	picture = GFX_evt_engineering_cache
	is_triggered_only = yes
	

	option = {
		name = oxr_mdlc_origin_wm_main.1005.a
	}
	immediate = {}
}
country_event = {
	# enter stage 3, boot loader
	id = oxr_mdlc_origin_wm_main.1010
	title = oxr_mdlc_origin_wm_main.1010.title
	desc = oxr_mdlc_origin_wm_main.1010.desc
	picture = GFX_evt_engineering_cache
	is_triggered_only = yes

	option = {
		name = oxr_mdlc_origin_wm_main.1010.a
	}
	immediate = {}
}
country_event = {
	# enter stage 4, booting
	id = oxr_mdlc_origin_wm_main.1015
	title = oxr_mdlc_origin_wm_main.1015.title
	desc = oxr_mdlc_origin_wm_main.1015.desc
	picture = GFX_evt_engineering_cache
	is_triggered_only = yes

	option = {
		name = oxr_mdlc_origin_wm_main.1015.a
	}
	immediate = {}
}
country_event = {
	# enter stage 5, continue installation
	id = oxr_mdlc_origin_wm_main.1020
	title = oxr_mdlc_origin_wm_main.1020.title
	desc = oxr_mdlc_origin_wm_main.1020.desc
	picture = GFX_evt_engineering_cache
	is_triggered_only = yes

	option = {
		name = oxr_mdlc_origin_wm_main.1020.a
	}
	immediate = {}
}
# ALL DONE WITH RESTORATION
country_event = {
	id = oxr_mdlc_origin_wm_main.1025
	title = oxr_mdlc_origin_wm_main.1025.title
	desc = oxr_mdlc_origin_wm_main.1025.desc
	picture = GFX_evt_colony_settlement
	is_triggered_only = yes

	immediate = {
		event_target:oxr_mdlc_ruined_world_machine = {
			change_pc = xvcv_mdlc_pc_machine_auto
			planet_event = { id = oxr_mdlc_origin_wm_main.500 }
		}
	}

	option = {
		name = oxr_mdlc_origin_wm_main.1025.a
		add_resource = {
			physics_research = 750
			society_research = 750
			engineering_research = 750
			unity = 500
		}
		hidden_effect = {
			if = {
				limit = {
					has_event_chain = "oxr_mdlc_origin_wm_chain_deploy_world_cores"
					NOT = { has_completed_event_chain = oxr_mdlc_origin_wm_chain_deploy_world_cores }
				}
				# bump up the event chain tracker
				country_event = {
					id = oxr_mdlc_origin_wm_main.1100
				}
			}
		}
	}
}
# Add progress to initial 'Expand empire' situation
country_event = {
	id = oxr_mdlc_origin_wm_main.1100
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_event_chain = oxr_mdlc_origin_wm_chain_deploy_world_cores
	}

	immediate = {
		if = {
			limit = {
				has_event_chain = "oxr_mdlc_origin_wm_chain_deploy_world_cores"
				NOT = { has_completed_event_chain = oxr_mdlc_origin_wm_chain_deploy_world_cores }
			}
			add_event_chain_counter = {
				event_chain = "oxr_mdlc_origin_wm_chain_deploy_world_cores"
				counter = "oxr_mdlc_origin_wm_starting_cores_deployed"
				amount = 1
			}
			# TODO: award insight points
		}
		# check for completion
		if = {
			limit = {
				has_completed_event_chain_counter = {
					event_chain = "oxr_mdlc_origin_wm_chain_deploy_world_cores"
					counter = "oxr_mdlc_origin_wm_starting_cores_deployed"
				}
				NOT = {
					has_technology = oxr_mdlc_tech_world_machine_planetary_proficiency
				}
			}
			# Trigger completion
			country_event = {
				id = oxr_mdlc_origin_wm_main.60
			}
		}
	}
}

# Completed gathering World Machine insights
country_event = {
	id = oxr_mdlc_origin_wm_main.1200
	title = oxr_mdlc_origin_wm_main.1200.title
	desc = oxr_mdlc_origin_wm_main.1200.desc
	picture = GFX_evt_analyzing_artifacts
	is_triggered_only = yes

	option = {
		name = oxr_mdlc_origin_wm_main.1200.a
		enable_special_project = {
			name = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_PHYSICS_1
		}
		enable_special_project = {
			name = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_ENGINEERING
		}
		enable_special_project = {
			name = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_SOCIETY
		}
	}
}

country_event = {
	id = oxr_mdlc_origin_wm_main.1205
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_completed_special_project_in_log = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_ENGINEERING
		has_completed_special_project_in_log = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_PHYSICS_1
		has_completed_special_project_in_log = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_SOCIETY
	}

	immediate = {
		if = {
			limit = {
				has_completed_special_project_in_log = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_ENGINEERING
				has_completed_special_project_in_log = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_PHYSICS_1
				has_completed_special_project_in_log = OXR_MDLC_ORIGIN_WM_CORE_TECH_RESEARCH_SOCIETY
		
			}
			country_event = {
				id = oxr_mdlc_origin_wm_main.1210
			}
		}
	}
}

# Completed special project to research World Machine Cores
# have all been completed
country_event = {
	id = oxr_mdlc_origin_wm_main.1210
	title = "oxr_mdlc_origin_wm_main.1210.title"
	desc = "oxr_mdlc_origin_wm_main.1210.desc"
	picture = GFX_evt_sapient_AI
	show_sound = event_mind_over_matter
	is_triggered_only = yes

	option = {
		name = "oxr_mdlc_origin_wm_main.1210.a"
		set_country_flag = oxr_mdlc_world_machine_core_tech_obtained
		owner = {
			add_research_option = oxr_mdlc_tech_fractal_basics
		}
		give_technology = {
			tech = oxr_mdlc_tech_world_machine_wmc_core
			message = no
		}
	}
}

# Manufacturing WMC
planet_event = {
	id = oxr_mdlc_origin_wm_main.1300
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		add_modifier = {
			modifier = oxr_mdlc_origin_world_machine_core_manufacturing_in_progress
			# days = @oxr_mdlc_world_machine_core_build_time_days
			days = 15
		}
		set_variable = {
			which = oxr_mdlc_planet_world_machine_core_countdown
			# value = @oxr_mdlc_world_machine_core_build_time_days
			value = 15
		}
		planet_event = {
			id = oxr_mdlc_origin_wm_main.1305
		}
	}
}

# Every day, check that the "in_progress" modifier is still active
# If it's not, reset
planet_event = {
	id = oxr_mdlc_origin_wm_main.1305
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_modifier = oxr_mdlc_origin_world_machine_core_manufacturing_in_progress
	}
	immediate = {
		if = {
			limit = {
				NOT = {
					has_modifier = oxr_mdlc_origin_world_machine_core_manufacturing_in_progress
				}
			}
			# Player cancelled the construction, so stop
			log = "Stopping construction of WMC, from inside the 'watcher' event"
		}
		else = {
			# Continue, since the construction is still active
			subtract_variable = {
				which = oxr_mdlc_planet_world_machine_core_countdown
				value = 1
			}
			if = {
				limit = {
					check_variable = {
						which = oxr_mdlc_planet_world_machine_core_countdown
						value = 0
					}
				}
				# Manufacturing is complete!
				planet_event = {
					id = oxr_mdlc_origin_wm_main.1310
					days = 1
				}
			}
			else_if = {
				limit = {
					check_variable = {
						which = oxr_mdlc_planet_world_machine_core_countdown
						value < 0
					}
				}
				log = "Something weird happen while counting down WMC construction."
				log = "The counter was below 0"
				# Stop and don't loop
			}
			else = {
				# Loop
				planet_event = {
					id = oxr_mdlc_origin_wm_main.1305
					days = 1
				}
			}
		}
	}
}


# WMC Finished being fabricated
planet_event = {
	id = oxr_mdlc_origin_wm_main.1310
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		# Is there enough room to add this WMC? if not, refund it
		# In case the player spammed active/inactive to try and get many cores
		# oxr_mdlc_world_machine_cores_add = { AMOUNT = 1 }
		space_owner = {
			add_resource = {
				oxr_mdlc_world_machine_core = 1
			}
		}
		log = "Added $AMOUNT$ World Machine Cores"
		hidden_effect = {
			space_owner = {
				change_variable = {
					which = oxr_mdlc_origin_wm_cores_current_count
					value = 1
				}
				change_variable = {
					which = oxr_mdlc_origin_wm_cores_total_produced_count
					value = 1
				}
			}
			# planet
			change_variable = {
				which = oxr_mdlc_planet_world_machine_cores_amount
				value = 1
			}
		}
		# oxr_mdlc_world_machine_cores_update_max_var = yes
		set_variable = {
			which = oxr_mdlc_origin_wm_cores_max
			value = modifier:country_resource_max_oxr_mdlc_world_machine_core_add
		}
		remove_modifier = oxr_mdlc_origin_world_machine_core_manufacturing_in_progress
		# create message
		create_message = {
			type = OXR_MDLC_ORIGIN_WM_CORE_FABRICATION_FINISHED
			localization = OXR_MDLC_ORIGIN_WM_CORE_FABRICATION_FINISHED_MESSAGE
			days = 20
			target = this
			variable = {
				type = name
				localization = OXR_MDLC_ORIGIN_WM_CORE_FABRICATION_PLANET
				scope = this
			}
		}
	}
}

# Start the loop of refilling planetary district armies
planet_event = {
	id = oxr_mdlc_origin_wm_main.2001
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		space_owner = { has_origin = oxr_mdlc_origin_world_machine_awakened }
		is_planet_world_machine = yes
		# re-use trigger to check if last district changed was WM district
		# xvcv_mdlc_world_machines_districts_heat_indicators_calc_trigger = yes
		has_planet_flag = oxr_mdlc_world_machines_refilling_armies_active
	}

	pre_triggers = {
		is_occupied_flag = no
	}

	immediate = {
		oxr_mdlc_origin_world_machine_calc_max_district_armies = yes
		oxr_mdlc_origin_world_machine_calc_current_district_armies = yes
		if = {
			limit = {
				check_variable = {
					which = oxr_mdlc_world_machine_num_existing_district_armies
					value < oxr_mdlc_world_machine_num_max_district_armies
				}
			}
			oxr_mdlc_origin_world_machine_add_district_defense_army_t1 = yes
			log = "Restocked district defense army."
			oxr_mdlc_origin_world_machine_calc_current_district_armies = yes
			if = {
				limit = {
					has_planet_flag = oxr_mdlc_world_machines_refilling_armies_active
				}
				add_modifier = {
					modifier = oxr_mdlc_world_machine_district_army_restock_in_progress
					days = 7
				}
				planet_event = {
					id = oxr_mdlc_origin_wm_main.2001
					days = 7
				}
			}
			else = {
				# Stop looping
				remove_modifier = oxr_mdlc_world_machine_district_army_restock_in_progress
			}
		}
		else = {
			# Stop looping
			remove_modifier = oxr_mdlc_world_machine_district_army_restock_in_progress
			remove_planet_flag = oxr_mdlc_world_machines_refilling_armies_active
		}
		
	}
}

planet_event = {
	id = oxr_mdlc_origin_wm_main.2100
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		space_owner = { has_origin = oxr_mdlc_origin_world_machine_awakened }
		is_planet_world_machine = yes
	}

	pre_triggers = {
		is_occupied_flag = no
	}
	immediate = {
		add_modifier = {
			modifier = oxr_mdlc_planet_origin_world_machine_automaton_pop_timer
			days = 180
		}
		while = {
			count = @oxr_mdlc_world_machine_decision_temp_automaton_amount_1
			create_pop = {
				species = owner.species
			}
			last_created_pop = {
				add_modifier = {
					modifier = oxr_mdlc_pop_origin_world_machine_automaton_timer
					days = 180
				}
				# Self-decommission .. bye bye
				pop_event = {
					id = oxr_mdlc_origin_wm_main.2110
					days = 180
				}
			}
		}
	}
}

pop_event = {
	id = oxr_mdlc_origin_wm_main.2110
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		# owner = { has_origin = oxr_mdlc_origin_world_machine_awakened }
		has_modifier = oxr_mdlc_pop_origin_world_machine_automaton_timer
	}
	immediate = {
		kill_pop = yes
	}
}
namespace = oxr_mdlc_on_world_machine_action

# on_world_machine_blocker_digsite_finished
planet_event = {
	# Create the next digsite, if requirements are met
	id = oxr_mdlc_on_world_machine_action.10
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		oxr_mdlc_planet_has_any_world_machine_blockers = yes
	}

	immediate = {
		if = {
			limit = {
				oxr_mdlc_planet_has_any_world_machine_blockers = yes
				NOT = {
					space_owner = {
						has_technology = oxr_mdlc_tech_world_machine_planetary_proficiency
					}
				}
			}
			# Create the digsite a few days later, it's weird for it to be immediately available
			planet_event = {
				id = oxr_mdlc_on_world_machine_action.11 days = 14
			}
			log = "Created a new world machine digsite at \\[This.GetName]"
		}
		else_if = {
			limit = { oxr_mdlc_planet_has_any_world_machine_blockers = no }
			log = "No more world machine blockers on \\[This.GetName]"
		}
		else_if = {
			limit = {
				space_owner = {
					has_technology = oxr_mdlc_tech_world_machine_planetary_proficiency
				}
			}
			log = "Space owner has tech oxr_mdlc_tech_world_machine_planetary_proficiency. Not going to make digsites."
		}
	}
}

# on_world_machine_blocker_digsite_finished
# Create the digsite a few days later
planet_event = {
	id = oxr_mdlc_on_world_machine_action.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		oxr_mdlc_planet_has_any_world_machine_blockers = yes
	}
	immediate = {
		oxr_mdlc_origin_world_machine_create_digsite_for_blocker = yes
	}
}

# Increment blockers cleared
country_event = {
	id = oxr_mdlc_on_world_machine_action.100
	hide_window = yes
	is_triggered_only = yes
	trigger = {
			has_event_chain = "oxr_mdlc_origin_wm_chain_clear_blockers"
			NOT = { has_completed_event_chain = oxr_mdlc_origin_wm_chain_clear_blockers }
	}

	immediate = {
		if = {
			limit = {
				has_event_chain = "oxr_mdlc_origin_wm_chain_clear_blockers"
				NOT = { has_completed_event_chain = oxr_mdlc_origin_wm_chain_clear_blockers }
			}
			add_event_chain_counter = {
				event_chain = "oxr_mdlc_origin_wm_chain_clear_blockers"
				counter = "oxr_mdlc_origin_wm_blockers"
				amount = 1
			}
			# TODO: contribute towards ongoing situation
			if = {
				limit = {
					has_completed_event_chain_counter = {
						event_chain = "oxr_mdlc_origin_wm_chain_clear_blockers"
						counter = "oxr_mdlc_origin_wm_blockers"
					}
					NOT = {
						has_technology = oxr_mdlc_tech_world_machine_planetary_proficiency
					}
				}
				# Trigger completion
				country_event = {
					id = oxr_mdlc_origin_wm_main.50
				}
			}
		}
	}
}

# Increments WM insights gained
country_event = {
	id = oxr_mdlc_on_world_machine_action.110
	hide_window = yes
	is_triggered_only = yes
	trigger = { }

	immediate = {
		if = {
			limit = {
				has_event_chain = "oxr_mdlc_origin_wm_chain_gather_insights"
				NOT = { has_completed_event_chain = oxr_mdlc_origin_wm_chain_gather_insights }
			}
			add_event_chain_counter = {
				event_chain = "oxr_mdlc_origin_wm_chain_gather_insights"
				counter = "oxr_mdlc_origin_wm_core_insights"
				amount = 1
			}
		}
	}
}

## SITUATION ADVANCEMENT EVENTS ##
# Points for digsite cleared 1000
country_event = {
	id = oxr_mdlc_on_world_machine_action.1000
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insight_digsite_points
			ON_ACTION_TYPE = on_world_machine_blocker_digsite_finished
		}
	}
}
# blocker cleared 1001
country_event = {
	id = oxr_mdlc_on_world_machine_action.1001
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insights_on_world_machine_blocker_cleared_points
			ON_ACTION_TYPE = on_world_machine_blocker_cleared
		}
	}
}
# Arc site stage finished 1002
country_event = {
	id = oxr_mdlc_on_world_machine_action.1002
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insights_on_world_machine_arc_site_progress_points
			ON_ACTION_TYPE = on_world_machine_arc_site_progress
		}
	}
}
# insight blocker cleared 1003
country_event = {
	id = oxr_mdlc_on_world_machine_action.1003
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insights_on_world_machine_insight_blocker_cleared_points
			ON_ACTION_TYPE = on_world_machine_insight_blocker_cleared
		}
	}
}
# on_world_machine_discovered 1004
country_event = {
	id = oxr_mdlc_on_world_machine_action.1004
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insights_on_world_machine_ruin_discovered
			ON_ACTION_TYPE = on_world_machine_ruined_planet_discovered
		}
	}
}
# on_world_machine_popless_building_constructed 1005
country_event = {
	id = oxr_mdlc_on_world_machine_action.1005
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insight_wm_building_constructed
			ON_ACTION_TYPE = on_world_machine_popless_building_constructed
		}
	}
}
# on_world_machine_district_completed 1006
country_event = {
	id = oxr_mdlc_on_world_machine_action.1006
	is_triggered_only = yes hide_window = yes
	trigger = {
		any_situation = { is_situation_type = oxr_mdlc_origin_wm_situation_recover_core_tech }
	}
	immediate = {
		oxr_mdlc_situation_core_insights_add_progress = {
			AMOUNT = @oxr_mdlc_situation_core_insight_build_district_points
			ON_ACTION_TYPE = on_world_machine_district_completed
		}
	}
}

# on_planet_surveyed, see if it's a ruined WM and trigger an arc site
planet_event = {
	id = oxr_mdlc_on_world_machine_action.1100
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		from = { has_origin = oxr_mdlc_origin_world_machine_awakened }
		is_planet_class = xvcv_mdlc_pc_machine_auto_ruined
	}
	immediate = {
		if = {
			limit = {
				is_planet_class = xvcv_mdlc_pc_machine_auto_ruined
				from = { has_origin = oxr_mdlc_origin_world_machine_awakened }
			}
			# Random arc site from blocker
			oxr_mdlc_origin_world_machine_create_digsite_for_blocker = yes
			log = "Created initial dig site on ruined WM, [This.GetName] for [This.From.GetName]"
		}
	}
}